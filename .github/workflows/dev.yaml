name: "[Dev] Publish styles"

on:
  pull_request:
    types: [closed]
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  
jobs:
  publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: "Checkout"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js 
      uses: actions/setup-node@v4
      with:
        node-version: '24.4.1'
        registry-url: 'https://registry.npmjs.org'

    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          .yarn/install-state.gz
          .yarn/cache
        key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock', '.yarnrc.yml') }}

    - name: Install 
      run: yarn install --immutable

    - name: Install mapka cli
      run: curl -fsSL https://download.mapka.dev/install-mapka-cli.sh | bash
      
    - name: Publish openmaptiles styles
      working-directory: openmaptiles
      env: 
        MAPKA_ACCOUNT_NAME: openmaptiles
        MAPKA_API_URL: https://api.dev.mapka.dev
        MAPKA_API_KEY: ${{ secrets.MAPKA_DEV_OPENMAPTILES_API_KEY }}
      run: |
        cd dark-matter-gl-style
        yarn import
        mapka map push --yes --publish
        cd ..

        cd osm-bright-gl-style
        yarn import
        mapka map push --yes --publish
        cd ..

        cd positron-gl-style
        yarn import
        mapka map push --yes --publish
    
    - name: Publish maputnik styles
      working-directory: maputnik
      env: 
        MAPKA_ACCOUNT_NAME: maputnik
        MAPKA_API_KEY: ${{ secrets.MAPKA_DEV_MAPUTNIK_API_KEY }}
      run: |
        cd osm-liberty
        yarn import
        mapka map push --yes --publish
        cd ..